name: Check PHP Version Updates

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    outputs:
      main-updated: ${{ steps.update.outputs.main-updated }}
      oci-updated: ${{ steps.update.outputs.oci-updated }}
      new-main-version: ${{ steps.update.outputs.new-main-version }}
      new-main-short: ${{ steps.update.outputs.new-main-short }}
      new-oci-version: ${{ steps.update.outputs.new-oci-version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current versions from repo
        id: current
        run: |
          # Main track version from docker-publish.yml
          CURRENT_MAIN=$(grep -oP 'PHP_VERSION=\K[0-9]+\.[0-9]+\.[0-9]+' .github/workflows/docker-publish.yml | head -1)
          CURRENT_MAIN_SHORT=$(echo "$CURRENT_MAIN" | grep -oP '^\d+\.\d+')

          # OCI track version from oci/Dockerfile
          CURRENT_OCI=$(grep -oP 'ARG PHP_VERSION=\K[0-9]+\.[0-9]+\.[0-9]+' oci/Dockerfile)
          CURRENT_OCI_SHORT=$(echo "$CURRENT_OCI" | grep -oP '^\d+\.\d+')

          echo "main=$CURRENT_MAIN" >> "$GITHUB_OUTPUT"
          echo "main-short=$CURRENT_MAIN_SHORT" >> "$GITHUB_OUTPUT"
          echo "oci=$CURRENT_OCI" >> "$GITHUB_OUTPUT"
          echo "oci-short=$CURRENT_OCI_SHORT" >> "$GITHUB_OUTPUT"

          echo "Current main track: $CURRENT_MAIN (${CURRENT_MAIN_SHORT}.x)"
          echo "Current OCI track:  $CURRENT_OCI (${CURRENT_OCI_SHORT}.x)"

      - name: Fetch all PHP versions from Docker Hub
        id: fetch
        run: |
          # Fetch all fpm-bookworm tags (paginated) to discover versions
          ALL_VERSIONS=""
          PAGE=1
          while true; do
            RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/library/php/tags/?page_size=100&page=${PAGE}&name=fpm-bookworm")
            TAGS=$(echo "$RESPONSE" | jq -r '.results[]?.name // empty')
            if [ -z "$TAGS" ]; then
              break
            fi
            ALL_VERSIONS="${ALL_VERSIONS}${TAGS}"$'\n'
            NEXT=$(echo "$RESPONSE" | jq -r '.next // empty')
            if [ -z "$NEXT" ]; then
              break
            fi
            PAGE=$((PAGE + 1))
          done

          # Extract X.Y.Z versions from tags matching X.Y.Z-fpm-bookworm
          PHP_VERSIONS=$(echo "$ALL_VERSIONS" | grep -oP '^\d+\.\d+\.\d+(?=-fpm-bookworm$)' | sort -t. -k1,1n -k2,2n -k3,3n | uniq)

          echo "All discovered PHP versions with fpm-bookworm:"
          echo "$PHP_VERSIONS"

          # Find latest version for current main minor line
          CURRENT_MAIN_SHORT="${{ steps.current.outputs.main-short }}"
          LATEST_MAIN=$(echo "$PHP_VERSIONS" | grep "^${CURRENT_MAIN_SHORT}\." | tail -1)

          # Find latest version for current OCI minor line
          CURRENT_OCI_SHORT="${{ steps.current.outputs.oci-short }}"
          LATEST_OCI=$(echo "$PHP_VERSIONS" | grep "^${CURRENT_OCI_SHORT}\." | tail -1)

          # Detect if a newer minor version exists (e.g., 8.6.x when on 8.5.x)
          MAJOR=$(echo "$CURRENT_MAIN_SHORT" | cut -d. -f1)
          ALL_MINORS=$(echo "$PHP_VERSIONS" | grep "^${MAJOR}\." | grep -oP '^\d+\.\d+' | sort -t. -k1,1n -k2,2n | uniq)
          HIGHEST_MINOR=$(echo "$ALL_MINORS" | tail -1)

          if [ "$HIGHEST_MINOR" != "$CURRENT_MAIN_SHORT" ]; then
            # A newer minor version line exists
            LATEST_NEW_MINOR=$(echo "$PHP_VERSIONS" | grep "^${HIGHEST_MINOR}\." | tail -1)
            echo "New minor version line detected: ${HIGHEST_MINOR}.x (latest: $LATEST_NEW_MINOR)"
            echo "new-minor=$LATEST_NEW_MINOR" >> "$GITHUB_OUTPUT"
            echo "new-minor-short=$HIGHEST_MINOR" >> "$GITHUB_OUTPUT"
          fi

          echo "latest-main=$LATEST_MAIN" >> "$GITHUB_OUTPUT"
          echo "latest-oci=$LATEST_OCI" >> "$GITHUB_OUTPUT"

          echo "Latest for main track (${CURRENT_MAIN_SHORT}.x): $LATEST_MAIN"
          echo "Latest for OCI track (${CURRENT_OCI_SHORT}.x): $LATEST_OCI"

      - name: Fetch FrankenPHP versions from Docker Hub
        id: franken
        run: |
          ALL_TAGS=""
          PAGE=1
          while true; do
            RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/dunglas/frankenphp/tags/?page_size=100&page=${PAGE}&name=bookworm")
            TAGS=$(echo "$RESPONSE" | jq -r '.results[]?.name // empty')
            if [ -z "$TAGS" ]; then
              break
            fi
            ALL_TAGS="${ALL_TAGS}${TAGS}"$'\n'
            NEXT=$(echo "$RESPONSE" | jq -r '.next // empty')
            if [ -z "$NEXT" ]; then
              break
            fi
            PAGE=$((PAGE + 1))
          done

          # Extract PHP versions from 1-phpX.Y.Z-bookworm tags
          FRANKEN_VERSIONS=$(echo "$ALL_TAGS" | grep -oP '(?<=^1-php)\d+\.\d+\.\d+(?=-bookworm$)' | sort -t. -k1,1n -k2,2n -k3,3n | uniq)

          echo "FrankenPHP available PHP versions:"
          echo "$FRANKEN_VERSIONS"

          # Store as comma-separated for easy lookup
          FRANKEN_LIST=$(echo "$FRANKEN_VERSIONS" | tr '\n' ',' | sed 's/,$//')
          echo "versions=$FRANKEN_LIST" >> "$GITHUB_OUTPUT"

      - name: Determine updates needed
        id: update
        run: |
          CURRENT_MAIN="${{ steps.current.outputs.main }}"
          CURRENT_MAIN_SHORT="${{ steps.current.outputs.main-short }}"
          CURRENT_OCI="${{ steps.current.outputs.oci }}"
          LATEST_MAIN="${{ steps.fetch.outputs.latest-main }}"
          LATEST_OCI="${{ steps.fetch.outputs.latest-oci }}"
          NEW_MINOR="${{ steps.fetch.outputs.new-minor }}"
          NEW_MINOR_SHORT="${{ steps.fetch.outputs.new-minor-short }}"
          FRANKEN_VERSIONS="${{ steps.franken.outputs.versions }}"

          MAIN_UPDATED="false"
          OCI_UPDATED="false"
          NEW_MAIN_VERSION=""
          NEW_MAIN_SHORT=""
          NEW_OCI_VERSION=""

          # Decide the target main version
          # Prefer new minor version if available and FrankenPHP supports it
          if [ -n "$NEW_MINOR" ]; then
            if echo ",$FRANKEN_VERSIONS," | grep -q ",$NEW_MINOR,"; then
              echo "New minor version $NEW_MINOR is available and FrankenPHP supports it"
              NEW_MAIN_VERSION="$NEW_MINOR"
              NEW_MAIN_SHORT="$NEW_MINOR_SHORT"
            else
              echo "New minor version $NEW_MINOR exists but FrankenPHP does not support it yet, staying on ${CURRENT_MAIN_SHORT}.x"
              if [ "$LATEST_MAIN" != "$CURRENT_MAIN" ]; then
                # Check FrankenPHP has the latest patch for current minor
                if echo ",$FRANKEN_VERSIONS," | grep -q ",$LATEST_MAIN,"; then
                  NEW_MAIN_VERSION="$LATEST_MAIN"
                  NEW_MAIN_SHORT="$CURRENT_MAIN_SHORT"
                else
                  echo "FrankenPHP does not have $LATEST_MAIN yet, skipping main track update"
                fi
              fi
            fi
          elif [ "$LATEST_MAIN" != "$CURRENT_MAIN" ]; then
            # Same minor, newer patch
            if echo ",$FRANKEN_VERSIONS," | grep -q ",$LATEST_MAIN,"; then
              NEW_MAIN_VERSION="$LATEST_MAIN"
              NEW_MAIN_SHORT="$CURRENT_MAIN_SHORT"
            else
              echo "FrankenPHP does not have $LATEST_MAIN yet, skipping main track update"
            fi
          fi

          # Check OCI track
          if [ "$LATEST_OCI" != "$CURRENT_OCI" ] && [ -n "$LATEST_OCI" ]; then
            NEW_OCI_VERSION="$LATEST_OCI"
          fi

          # Validate that all required tags exist before proceeding
          if [ -n "$NEW_MAIN_VERSION" ]; then
            echo "Validating tags for main track version $NEW_MAIN_VERSION..."
            VALID=true
            for SUFFIX in apache-bookworm fpm-bookworm cli-bookworm; do
              TAG="php:${NEW_MAIN_VERSION}-${SUFFIX}"
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/library/php/tags/${NEW_MAIN_VERSION}-${SUFFIX}")
              if [ "$STATUS" != "200" ]; then
                echo "Tag $TAG not found (HTTP $STATUS), skipping main update"
                VALID=false
                break
              fi
              echo "  $TAG exists"
            done

            FRANKEN_TAG="dunglas/frankenphp:1-php${NEW_MAIN_VERSION}-bookworm"
            FRANKEN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/dunglas/frankenphp/tags/1-php${NEW_MAIN_VERSION}-bookworm")
            if [ "$FRANKEN_STATUS" != "200" ]; then
              echo "Tag $FRANKEN_TAG not found (HTTP $FRANKEN_STATUS), skipping main update"
              VALID=false
            else
              echo "  $FRANKEN_TAG exists"
            fi

            if [ "$VALID" = true ]; then
              MAIN_UPDATED="true"
              echo "Main track: $CURRENT_MAIN -> $NEW_MAIN_VERSION"
            else
              NEW_MAIN_VERSION=""
              NEW_MAIN_SHORT=""
            fi
          fi

          if [ -n "$NEW_OCI_VERSION" ]; then
            echo "Validating tags for OCI track version $NEW_OCI_VERSION..."
            OCI_TAG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/library/php/tags/${NEW_OCI_VERSION}-fpm-bookworm")
            if [ "$OCI_TAG_STATUS" = "200" ]; then
              OCI_UPDATED="true"
              echo "OCI track: $CURRENT_OCI -> $NEW_OCI_VERSION"
            else
              echo "Tag php:${NEW_OCI_VERSION}-fpm-bookworm not found, skipping OCI update"
              NEW_OCI_VERSION=""
            fi
          fi

          if [ "$MAIN_UPDATED" = "false" ] && [ "$OCI_UPDATED" = "false" ]; then
            echo "No updates found. All versions are up to date."
          fi

          echo "main-updated=$MAIN_UPDATED" >> "$GITHUB_OUTPUT"
          echo "oci-updated=$OCI_UPDATED" >> "$GITHUB_OUTPUT"
          echo "new-main-version=$NEW_MAIN_VERSION" >> "$GITHUB_OUTPUT"
          echo "new-main-short=$NEW_MAIN_SHORT" >> "$GITHUB_OUTPUT"
          echo "new-oci-version=$NEW_OCI_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update files
        if: steps.update.outputs.main-updated == 'true' || steps.update.outputs.oci-updated == 'true'
        run: |
          NEW_MAIN="${{ steps.update.outputs.new-main-version }}"
          NEW_MAIN_SHORT="${{ steps.update.outputs.new-main-short }}"
          NEW_OCI="${{ steps.update.outputs.new-oci-version }}"

          MAIN_DOCKERFILES="apache cli dev fpm supervisor franken supervisor-franken"
          OCI_DOCKERFILES="oci supervisor-oci"

          if [ -n "$NEW_MAIN" ]; then
            echo "Updating main track Dockerfiles to PHP $NEW_MAIN..."
            for DIR in $MAIN_DOCKERFILES; do
              sed -i "s/^ARG PHP_VERSION=.*/ARG PHP_VERSION=${NEW_MAIN}/" "${DIR}/Dockerfile"
              echo "  Updated ${DIR}/Dockerfile"
            done

            echo "Updating docker-publish.yml..."
            sed -i "s/^\( *\)PHP_SHORT_VERSION=.*/\1PHP_SHORT_VERSION=${NEW_MAIN_SHORT}/" .github/workflows/docker-publish.yml
            sed -i "s/^\( *\)PHP_VERSION=[0-9].*/\1PHP_VERSION=${NEW_MAIN}/" .github/workflows/docker-publish.yml
            echo "  Updated .github/workflows/docker-publish.yml"
          fi

          if [ -n "$NEW_OCI" ]; then
            echo "Updating OCI track Dockerfiles to PHP $NEW_OCI..."
            for DIR in $OCI_DOCKERFILES; do
              sed -i "s/^ARG PHP_VERSION=.*/ARG PHP_VERSION=${NEW_OCI}/" "${DIR}/Dockerfile"
              echo "  Updated ${DIR}/Dockerfile"
            done
          fi

      - name: Commit and push
        if: steps.update.outputs.main-updated == 'true' || steps.update.outputs.oci-updated == 'true'
        run: |
          CURRENT_MAIN="${{ steps.current.outputs.main }}"
          CURRENT_OCI="${{ steps.current.outputs.oci }}"
          NEW_MAIN="${{ steps.update.outputs.new-main-version }}"
          NEW_OCI="${{ steps.update.outputs.new-oci-version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          # Build commit message
          MSG="chore: auto-update PHP version"
          DETAILS=""
          if [ -n "$NEW_MAIN" ]; then
            DETAILS="${DETAILS}\n- Main track: ${CURRENT_MAIN} -> ${NEW_MAIN}"
          fi
          if [ -n "$NEW_OCI" ]; then
            DETAILS="${DETAILS}\n- OCI track: ${CURRENT_OCI} -> ${NEW_OCI}"
          fi

          git commit -m "${MSG}" -m "$(echo -e "$DETAILS")"
          git push

  build-and-push-main:
    needs: check-and-update
    if: needs.check-and-update.outputs.main-updated == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image-variant: ['franken', 'apache', 'cli', 'fpm', 'supervisor', 'dev', 'supervisor-franken']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Log into registry
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY_URL }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Build and push the images
        run: |
          VERSION=${{ matrix.image-variant }}
          PHP_VERSION="${{ needs.check-and-update.outputs.new-main-version }}"
          PHP_SHORT_VERSION="${{ needs.check-and-update.outputs.new-main-short }}"

          tmpName="image-$RANDOM"
          docker build $VERSION --file $VERSION/Dockerfile --tag $tmpName --build-arg PHP_VERSION=$PHP_VERSION
          if [ $? -ne 0 ]; then
            echo "Docker build failed for ${VERSION}-$PHP_VERSION"
            exit 1
          fi

          IMAGE_ID=${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}

          docker tag $tmpName $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
          if [ "$VERSION" == "fpm" ]; then
            docker tag $tmpName $IMAGE_ID:latest
            docker push $IMAGE_ID:latest
          fi

  build-and-push-oci:
    needs: check-and-update
    if: needs.check-and-update.outputs.oci-updated == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image-variant: ['oci', 'supervisor-oci']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Log into registry
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY_URL }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Build and push the images
        run: |
          VERSION=${{ matrix.image-variant }}
          PHP_VERSION="${{ needs.check-and-update.outputs.new-oci-version }}"
          PHP_SHORT_VERSION=$(echo "$PHP_VERSION" | grep -oP '^\d+\.\d+')

          tmpName="image-$RANDOM"
          docker build $VERSION --file $VERSION/Dockerfile --tag $tmpName --build-arg PHP_VERSION=$PHP_VERSION
          if [ $? -ne 0 ]; then
            echo "Docker build failed for ${VERSION}-$PHP_VERSION"
            exit 1
          fi

          IMAGE_ID=${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}

          docker tag $tmpName $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
