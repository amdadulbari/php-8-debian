name: Check PHP Version Updates

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  workflow_dispatch: # Manual trigger

# ---------------------------------------------------------------
# Change this to track a different PHP minor line (e.g., 8.6)
# All Dockerfiles and builds will follow this version.
# ---------------------------------------------------------------
env:
  PHP_MINOR: '8.5'

permissions:
  contents: write
  workflows: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.update.outputs.updated }}
      new-version: ${{ steps.update.outputs.new-version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current PHP version from repo
        id: current
        run: |
          CURRENT=$(grep -oP 'PHP_VERSION=\K[0-9]+\.[0-9]+\.[0-9]+' .github/workflows/docker-publish.yml | head -1)
          echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "Current PHP version: $CURRENT"

      - name: Check latest PHP ${{ env.PHP_MINOR }}.x on Docker Hub
        id: fetch
        run: |
          echo "Fetching tags for PHP ${{ env.PHP_MINOR }}.x from Docker Hub..."

          ALL_TAGS=""
          PAGE=1
          while true; do
            RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/library/php/tags/?page_size=100&page=${PAGE}&name=${{ env.PHP_MINOR }}")
            TAGS=$(echo "$RESPONSE" | jq -r '.results[]?.name // empty')
            if [ -z "$TAGS" ]; then
              break
            fi
            ALL_TAGS="${ALL_TAGS}${TAGS}"$'\n'
            NEXT=$(echo "$RESPONSE" | jq -r '.next // empty')
            if [ -z "$NEXT" ]; then
              break
            fi
            PAGE=$((PAGE + 1))
          done

          # Extract versions matching X.Y.Z-fpm-bookworm within our minor line
          LATEST=$(echo "$ALL_TAGS" \
            | grep -oP '^${{ env.PHP_MINOR }}\.\d+(?=-fpm-bookworm$)' \
            | sort -t. -k1,1n -k2,2n -k3,3n \
            | tail -1)

          echo "Latest PHP ${{ env.PHP_MINOR }}.x: $LATEST"
          echo "version=$LATEST" >> "$GITHUB_OUTPUT"

      - name: Check FrankenPHP availability
        id: franken
        run: |
          LATEST="${{ steps.fetch.outputs.version }}"
          if [ -z "$LATEST" ]; then
            echo "No PHP version found, skipping"
            echo "available=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://hub.docker.com/v2/repositories/dunglas/frankenphp/tags/1-php${LATEST}-bookworm")

          if [ "$STATUS" = "200" ]; then
            echo "FrankenPHP 1-php${LATEST}-bookworm exists"
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "FrankenPHP 1-php${LATEST}-bookworm NOT found (HTTP $STATUS)"
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine if update is needed
        id: update
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.fetch.outputs.version }}"
          FRANKEN_OK="${{ steps.franken.outputs.available }}"

          if [ -z "$LATEST" ]; then
            echo "Could not determine latest version, skipping"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$LATEST" = "$CURRENT" ]; then
            echo "Already on latest version ($CURRENT). No update needed."
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$FRANKEN_OK" != "true" ]; then
            echo "FrankenPHP does not have PHP $LATEST yet. Skipping update."
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Validate all required official PHP tags exist
          echo "Validating all required tags for PHP $LATEST..."
          VALID=true
          for SUFFIX in apache-bookworm fpm-bookworm cli-bookworm; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://hub.docker.com/v2/repositories/library/php/tags/${LATEST}-${SUFFIX}")
            if [ "$STATUS" != "200" ]; then
              echo "  php:${LATEST}-${SUFFIX} NOT found (HTTP $STATUS)"
              VALID=false
              break
            fi
            echo "  php:${LATEST}-${SUFFIX} exists"
          done

          if [ "$VALID" != "true" ]; then
            echo "Not all tags available. Skipping update."
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Update available: $CURRENT -> $LATEST"
          echo "updated=true" >> "$GITHUB_OUTPUT"
          echo "new-version=$LATEST" >> "$GITHUB_OUTPUT"

      - name: Update Dockerfiles and workflow
        if: steps.update.outputs.updated == 'true'
        run: |
          NEW_VERSION="${{ steps.update.outputs.new-version }}"

          ALL_DOCKERFILES="apache cli dev fpm supervisor franken supervisor-franken oci supervisor-oci"

          echo "Updating all Dockerfiles to PHP $NEW_VERSION..."
          for DIR in $ALL_DOCKERFILES; do
            sed -i "s/^ARG PHP_VERSION=.*/ARG PHP_VERSION=${NEW_VERSION}/" "${DIR}/Dockerfile"
            echo "  Updated ${DIR}/Dockerfile"
          done

          echo "Updating docker-publish.yml..."
          sed -i "s/^\( *\)PHP_SHORT_VERSION=.*/\1PHP_SHORT_VERSION=${{ env.PHP_MINOR }}/" .github/workflows/docker-publish.yml
          sed -i "s/^\( *\)PHP_VERSION=[0-9].*/\1PHP_VERSION=${NEW_VERSION}/" .github/workflows/docker-publish.yml
          echo "  Updated .github/workflows/docker-publish.yml"

      - name: Commit and push
        if: steps.update.outputs.updated == 'true'
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          NEW_VERSION="${{ steps.update.outputs.new-version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "chore: auto-update PHP ${CURRENT} -> ${NEW_VERSION}"
          git push

  build-and-push:
    needs: check-and-update
    if: needs.check-and-update.outputs.updated == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image-variant: ['franken', 'apache', 'cli', 'fpm', 'supervisor', 'dev', 'supervisor-franken']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Log into registry
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY_URL }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Build and push the images
        run: |
          VERSION=${{ matrix.image-variant }}
          PHP_VERSION="${{ needs.check-and-update.outputs.new-version }}"
          PHP_SHORT_VERSION=${{ env.PHP_MINOR }}

          tmpName="image-$RANDOM"
          docker build $VERSION --file $VERSION/Dockerfile --tag $tmpName --build-arg PHP_VERSION=$PHP_VERSION
          if [ $? -ne 0 ]; then
            echo "Docker build failed for ${VERSION}-$PHP_VERSION"
            exit 1
          fi

          IMAGE_ID=${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.DOCKER_USERNAME }}/${{ secrets.IMAGE_NAME }}

          docker tag $tmpName $IMAGE_ID:$VERSION
          docker push $IMAGE_ID:$VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_VERSION
          docker tag $tmpName $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
          docker push $IMAGE_ID:${VERSION}-$PHP_SHORT_VERSION
          if [ "$VERSION" == "fpm" ]; then
            docker tag $tmpName $IMAGE_ID:latest
            docker push $IMAGE_ID:latest
          fi
